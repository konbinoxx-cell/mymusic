<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>🎵 自由音乐创作平台</title>
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <div class="container">
        <h1>🎵 自由音乐创作平台</h1>
        <p class="subtitle">写旋律 · 配和弦 · 填歌词 · 录人声 · 导出MP3</p>

        <!-- 五线谱编辑区 -->
        <div class="control-group">
            <label>🎼 五线谱（点击添加音符）</label>
            <div class="staff-editor">
                <div class="staff" id="staff">
                    <!-- 五线谱线条由 CSS 绘制 -->
                </div>
                <div class="note-palette">
                    <div class="note-option" data-note="C4">C4</div>
                    <div class="note-option" data-note="D4">D4</div>
                    <div class="note-option" data-note="E4">E4</div>
                    <div class="note-option" data-note="F4">F4</div>
                    <div class="note-option" data-note="G4">G4</div>
                    <div class="note-option" data-note="A4">A4</div>
                    <div class="note-option" data-note="B4">B4</div>
                    <div class="note-option" data-note="C5">C5</div>
                </div>
                <div class="staff-controls">
                    <button id="clearStaff">清空乐谱</button>
                    <button id="playStaff">播放旋律</button>
                </div>
            </div>
        </div>

        <!-- 🎹 新增：49键钢琴键盘 -->
        <div class="control-group">
            <label>🎹 49键钢琴键盘（C2 - C6）</label>
            <div class="piano-keyboard" id="pianoKeyboard">
                <!-- 键盘将由 JS 动态生成 -->
            </div>
        </div>

        <!-- 调式选择 -->
        <div class="control-group">
            <label>🎼 调式</label>
            <select id="key">
                <option value="C">C 大调</option>
                <option value="G">G 大调</option>
                <option value="D">D 大调</option>
                <option value="A">A 大调</option>
                <option value="Am">A 小调</option>
                <option value="Em">E 小调</option>
                <option value="Dm">D 小调</option>
            </select>
        </div>

        <!-- 和弦进行 -->
        <div class="control-group">
            <label>🎸 和弦进行（4小节）</label>
            <div class="chord-progression">
                <select class="chord-select">
                    <option>C</option>
                    <option>G</option>
                    <option>Am</option>
                    <option>F</option>
                    <option>Dm</option>
                    <option>Em</option>
                </select>
                <select class="chord-select">
                    <option>C</option>
                    <option selected>G</option>
                    <option>Am</option>
                    <option>F</option>
                    <option>Dm</option>
                    <option>Em</option>
                </select>
                <select class="chord-select">
                    <option>C</option>
                    <option>G</option>
                    <option selected>Am</option>
                    <option>F</option>
                    <option>Dm</option>
                    <option>Em</option>
                </select>
                <select class="chord-select">
                    <option>C</option>
                    <option>G</option>
                    <option>Am</option>
                    <option selected>F</option>
                    <option>Dm</option>
                    <option>Em</option>
                </select>
            </div>
        </div>

        <!-- 歌词区 -->
        <div class="control-group">
            <label>📝 歌词（支持 [和弦] 标记）</label>
            <textarea id="lyrics" placeholder="示例：
[Am] 今天的天空很蓝
[F] 我想和你一起唱歌"></textarea>
        </div>

        <!-- 风格与时间 -->
        <div class="controls">
            <div class="control-group">
                <label>🎨 音乐风格</label>
                <div class="preset-buttons">
                    <button class="preset-btn active" data-style="happy">😊 欢快</button>
                    <button class="preset-btn" data-style="calm">🌊 平静</button>
                    <button class="preset-btn" data-style="mystery">🔮 神秘</button>
                    <button class="preset-btn" data-style="energy">⚡ 活力</button>
                </div>
            </div>

            <div class="control-group">
                <label>⏱️ 时长</label>
                <select id="duration">
                    <option value="30">30 秒</option>
                    <option value="60" selected>60 秒</option>
                    <option value="120">2 分钟</option>
                </select>
            </div>
        </div>

        <!-- 操作按钮 -->
        <div class="action-buttons">
            <button id="generateBtn" class="generate-btn">🎵 生成完整歌曲</button>
            <button id="stopBtn" class="stop-btn">⏹️ 停止播放</button>
            <button id="recordBtn" class="record-btn">● 开始录音</button>
            <button id="exportBtn" class="export-btn" disabled>💾 导出MP3</button>
            <button id="exportMidi" class="export-btn">🎹 导出MIDI</button>
        </div>

        <!-- 状态提示 -->
        <div class="status">
            <div id="statusText">准备就绪 — 点击五线谱或键盘开始创作！</div>
            <div class="loading" id="loading" style="display: none;">生成中…</div>
        </div>

        <!-- 使用指南 -->
        <div class="instructions">
            <h3>💡 使用提示</h3>
            <ul>
                <li>点击五线谱或键盘添加音符，双击删除</li>
                <li>点击“开始录音”录制人声或乐器</li>
                <li>录音完成后可导出为 MP3 文件</li>
                <li>歌词中的 <code>[Am]</code> 会被识别为和弦标记</li>
            </ul>
        </div>
    </div>

    <!-- 引入 Tone.js -->
    <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>
    <!-- 引入 lamejs 用于 MP3 编码 -->
    <script src="https://cdn.jsdelivr.net/npm/lamejs@1.3.0/dist/lame.min.js"></script>
    <script src="script.js"></script>
</body>
</html>
